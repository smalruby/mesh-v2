<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Subscription Debug Tool</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .log {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      max-height: 500px;
      overflow-y: auto;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #007acc;
    }
    .log-entry.error {
      border-left-color: #f48771;
      color: #f48771;
    }
    .log-entry.success {
      border-left-color: #4ec9b0;
      color: #4ec9b0;
    }
    .log-entry.subscription {
      border-left-color: #ce9178;
      color: #ce9178;
    }
    input, button {
      padding: 8px;
      margin: 5px;
      font-family: monospace;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #2d2d2d;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>üîç AppSync Subscription Debug Tool</h1>

  <div class="section">
    <h3>Configuration</h3>
    <label>AppSync Endpoint:</label>
    <input type="text" id="endpoint" value="https://rb6mjlr72rhudiztdmfvoyctbq.appsync-api.ap-northeast-1.amazonaws.com/graphql" style="width: 600px">
    <br>
    <label>API Key:</label>
    <input type="text" id="apiKey" value="da2-kp6w6skjfjgpxb7ufwt25zophm" style="width: 400px">
    <br>
    <label>Group ID:</label>
    <input type="text" id="groupId" value="" placeholder="Enter group ID">
    <br>
    <label>Domain:</label>
    <input type="text" id="domain" value="test-domain">
    <br>
    <label>Node ID:</label>
    <input type="text" id="nodeId" value="debug-node-1">
  </div>

  <div class="section">
    <h3>Actions</h3>
    <button onclick="subscribe()">1. Subscribe to onDataUpdateInGroup</button>
    <button onclick="sendData()">2. Send Sensor Data</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <div class="section">
    <h3>Debug Log</h3>
    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { MeshClient } from './mesh-client.bundle.js';

    let meshClient = null;
    let subscriptionId = null;

    window.subscribe = async function() {
      const endpoint = document.getElementById('endpoint').value;
      const apiKey = document.getElementById('apiKey').value;
      const groupId = document.getElementById('groupId').value;
      const domain = document.getElementById('domain').value;

      if (!groupId) {
        addLog('error', 'Please enter a Group ID first!');
        return;
      }

      addLog('info', 'Creating MeshClient...');

      try {
        // Create MeshClient
        meshClient = new MeshClient({
          endpoint: endpoint,
          apiKey: apiKey,
          domain: domain
        });

        addLog('success', 'MeshClient created successfully');

        // Subscribe
        addLog('info', `Subscribing to onDataUpdateInGroup(groupId: "${groupId}", domain: "${domain}")...`);

        subscriptionId = meshClient.subscribeToDataUpdates(
          groupId,
          domain,
          (statuses) => {
            addLog('subscription', 'üéâ SUBSCRIPTION DATA RECEIVED!');
            addLog('subscription', `Received ${statuses.length} node status(es)`);
            statuses.forEach(status => {
              addLog('subscription', `- Node ${status.nodeId}: ${JSON.stringify(status.data)}`);
            });
          }
        );

        addLog('success', '‚úì Subscription established! Waiting for data updates...');
        addLog('info', 'Subscription ID: ' + subscriptionId);
        addLog('info', 'Now send sensor data from another window or use the "Send Sensor Data" button');

      } catch (error) {
        addLog('error', 'Failed to subscribe: ' + error.message);
        console.error(error);
      }
    };

    window.sendData = async function() {
      const groupId = document.getElementById('groupId').value;
      const domain = document.getElementById('domain').value;
      const nodeId = document.getElementById('nodeId').value;

      if (!groupId) {
        addLog('error', 'Please enter a Group ID first!');
        return;
      }

      if (!meshClient) {
        addLog('error', 'Please subscribe first to create MeshClient!');
        return;
      }

      addLog('info', `Sending sensor data from nodeId: "${nodeId}"...`);

      const sensorData = [
        { key: 'temperature', value: String(Math.floor(Math.random() * 30) + 10) },
        { key: 'debug-test', value: new Date().toISOString() }
      ];

      try {
        const result = await meshClient.reportDataByNode(
          nodeId,
          groupId,
          domain,
          sensorData
        );

        addLog('success', '‚úì Sensor data sent successfully!');
        addLog('info', 'Response: ' + JSON.stringify(result, null, 2));
        addLog('info', 'If subscription is working, you should see "SUBSCRIPTION DATA RECEIVED!" above');
      } catch (error) {
        addLog('error', 'Failed to send data: ' + error.message);
        console.error(error);
      }
    };

    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
    };

    function addLog(type, message) {
      const log = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
      console.log(`[${type}]`, message);
    }

    // Make addLog global for button onclick
    window.addLog = addLog;

    addLog('info', 'Debug tool ready');
    addLog('info', 'Step 1: Enter a Group ID (create a group in the main prototype first)');
    addLog('info', 'Step 2: Click "Subscribe to onDataUpdateInGroup"');
    addLog('info', 'Step 3: Click "Send Sensor Data" or send data from another window');
  </script>
</body>
</html>
