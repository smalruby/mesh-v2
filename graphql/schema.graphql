# --- データの基本構造 ---

input SensorDataInput {
  key: String!
  value: String!
}

type SensorData {
  key: String!
  value: String!
}

# --- 主要エンティティ ---

type Group {
  id: ID!           # group_id部分のみ
  domain: String!   # domain部分（グローバルIP or 任意文字列、最大256文字）
  fullId: String!   # {group_id}@{domain}の完全なID
  name: String!
  hostId: ID!
  createdAt: AWSDateTime!
  expiresAt: AWSDateTime!
}

type Node {
  id: ID!
  name: String!
  groupId: ID
  domain: String    # 所属しているdomain
  heartbeatIntervalSeconds: Int
}

type NodeStatus {
  nodeId: ID!
  groupId: ID!
  domain: String!
  data: [SensorData!]!
  timestamp: AWSDateTime!
}

type Event {
  name: String!
  firedByNodeId: ID!
  groupId: ID!
  domain: String!
  payload: String
  timestamp: AWSDateTime!
}

type GroupDissolvePayload {
  groupId: ID!
  domain: String!
  message: String!
}

type HeartbeatPayload {
  groupId: ID!
  domain: String!
  expiresAt: AWSDateTime!
  heartbeatIntervalSeconds: Int
}

type MemberHeartbeatPayload {
  nodeId: ID!
  groupId: ID!
  domain: String!
  expiresAt: AWSDateTime!
  heartbeatIntervalSeconds: Int
}

type LeaveGroupPayload {
  peerId: ID!
  groupId: ID!
  domain: String!
  message: String!
}

# --- クエリ (Queries) ---

type Query {
  # Domain内のグループ一覧取得（スキャン機能）
  listGroupsByDomain(domain: String!): [Group!]!

  # グループ取得
  getGroup(groupId: ID!, domain: String!): Group

  # NodeStatus取得
  getNodeStatus(nodeId: ID!): NodeStatus

  # グループ内の全NodeStatus取得
  listGroupStatuses(groupId: ID!, domain: String!): [NodeStatus!]!

  # グループ内の全Node取得
  listNodesInGroup(groupId: ID!, domain: String!): [Node!]!
}

# --- ミューテーション (Mutations) ---

type Mutation {
  # ドメイン管理
  # リクエスト元のソースIPからドメインを生成する
  createDomain: String!

  # グループ管理
  createGroup(
    name: String!
    hostId: ID!
    domain: String!
  ): Group!

  joinGroup(
    groupId: ID!
    domain: String!
    nodeId: ID!
  ): Node!

  leaveGroup(
    groupId: ID!
    domain: String!
    nodeId: ID!
  ): LeaveGroupPayload

  # Note: nullableにすることでSubscription型と一致させる
  dissolveGroup(
    groupId: ID!
    domain: String!
    hostId: ID!
  ): GroupDissolvePayload

  # ハートビート更新 (Host)
  renewHeartbeat(
    groupId: ID!
    domain: String!
    hostId: ID!
  ): HeartbeatPayload!

  # ハートビート更新 (Member)
  sendMemberHeartbeat(
    groupId: ID!
    domain: String!
    nodeId: ID!
  ): MemberHeartbeatPayload!

  # データ通信
  # Note: nullableにすることでSubscription型と一致させる
  reportDataByNode(
    groupId: ID!
    domain: String!
    nodeId: ID!
    data: [SensorDataInput!]!
  ): NodeStatus

  # Note: nullableにすることでSubscription型と一致させる
  fireEventByNode(
    groupId: ID!
    domain: String!
    nodeId: ID!
    eventName: String!
    payload: String
  ): Event
}

# --- サブスクリプション (Subscriptions) ---

type Subscription {
  # グループ内のデータ更新を購読
  # reportDataByNode mutation がトリガー
  # Note: nullableにすることで、NodeStatusが存在しない場合でもエラーを防ぐ
  onDataUpdateInGroup(groupId: ID!, domain: String!): NodeStatus
    @aws_subscribe(mutations: ["reportDataByNode"])

  # グループ内のイベントを購読
  # fireEventByNode mutation がトリガー
  # Note: nullableにすることで、Eventが存在しない場合でもエラーを防ぐ
  onEventInGroup(groupId: ID!, domain: String!): Event
    @aws_subscribe(mutations: ["fireEventByNode"])

  # グループ解散通知を購読
  # dissolveGroup mutation がトリガー
  # Note: nullableにすることで、GroupDissolvePayloadが存在しない場合でもエラーを防ぐ
  onGroupDissolve(groupId: ID!, domain: String!): GroupDissolvePayload
    @aws_subscribe(mutations: ["dissolveGroup"])
}

schema {
  query: Query
  mutation: Mutation
  subscription: Subscription
}
