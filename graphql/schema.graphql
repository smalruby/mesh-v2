# --- データの基本構造 ---

input SensorDataInput {
  key: String!
  value: String!
}

type SensorData {
  key: String!
  value: String!
}

# --- 主要エンティティ ---

type Group {
  id: ID!           # group_id部分のみ
  domain: String!   # domain部分（グローバルIP or 任意文字列、最大256文字）
  fullId: String!   # {group_id}@{domain}の完全なID
  name: String!
  hostId: ID!
  createdAt: AWSDateTime!
  expiresAt: AWSDateTime!
}

type Node {
  id: ID!
  name: String!
  groupId: ID
  domain: String    # 所属しているdomain
  heartbeatIntervalSeconds: Int
}

type NodeStatus {
  nodeId: ID!
  groupId: ID!
  domain: String!
  data: [SensorData!]!
  timestamp: AWSDateTime!
}

type Event {
  name: String!
  firedByNodeId: ID!
  groupId: ID!
  domain: String!
  payload: String
  timestamp: AWSDateTime!
}

# イベントのバッチ送信用の入力型
input EventInput {
  eventName: String!
  payload: String
  firedAt: AWSDateTime!  # イベント発火日時（ISO 8601形式、ミリ秒含む）
}

# バッチイベント型（複数イベントを含む）
type BatchEvent {
  events: [Event!]!      # イベントの配列
  firedByNodeId: ID!
  groupId: ID!
  domain: String!
  timestamp: AWSDateTime!
}

type GroupDissolvePayload {
  groupId: ID!
  domain: String!
  message: String!
}

type HeartbeatPayload {
  groupId: ID!
  domain: String!
  expiresAt: AWSDateTime!
  heartbeatIntervalSeconds: Int
}

type MemberHeartbeatPayload {
  nodeId: ID!
  groupId: ID!
  domain: String!
  expiresAt: AWSDateTime!
  heartbeatIntervalSeconds: Int
}

type LeaveGroupPayload {
  peerId: ID!
  groupId: ID!
  domain: String!
  message: String!
}

# --- クエリ (Queries) ---

type Query {
  # Domain内のグループ一覧取得（スキャン機能）
  listGroupsByDomain(domain: String!): [Group!]!

  # グループ取得
  getGroup(groupId: ID!, domain: String!): Group

  # NodeStatus取得
  getNodeStatus(nodeId: ID!): NodeStatus

  # グループ内の全NodeStatus取得
  listGroupStatuses(groupId: ID!, domain: String!): [NodeStatus!]!

  # グループ内の全Node取得
  listNodesInGroup(groupId: ID!, domain: String!): [Node!]!
}

# --- ミューテーション (Mutations) ---

type Mutation {
  # ドメイン管理
  # リクエスト元のソースIPからドメインを生成する
  createDomain: String!

  # グループ管理
  createGroup(
    name: String!
    hostId: ID!
    domain: String!
    maxConnectionTimeSeconds: Int  # オプション: 1以上、環境変数の値以下
  ): Group!

  joinGroup(
    groupId: ID!
    domain: String!
    nodeId: ID!
  ): Node!

  leaveGroup(
    groupId: ID!
    domain: String!
    nodeId: ID!
  ): LeaveGroupPayload

  # Note: nullableにすることでSubscription型と一致させる
  dissolveGroup(
    groupId: ID!
    domain: String!
    hostId: ID!
  ): GroupDissolvePayload

  # ハートビート更新 (Host)
  renewHeartbeat(
    groupId: ID!
    domain: String!
    hostId: ID!
  ): HeartbeatPayload!

  # ハートビート更新 (Member)
  sendMemberHeartbeat(
    groupId: ID!
    domain: String!
    nodeId: ID!
  ): MemberHeartbeatPayload!

  # データ通信
  # Note: nullableにすることでSubscription型と一致させる
  reportDataByNode(
    groupId: ID!
    domain: String!
    nodeId: ID!
    data: [SensorDataInput!]!
  ): NodeStatus

  # 複数イベントを一度に送信（1回のSubscriptionを発火）
  fireEventsByNode(
    groupId: ID!
    domain: String!
    nodeId: ID!
    events: [EventInput!]!
  ): BatchEvent
}

# --- サブスクリプション (Subscriptions) ---

type Subscription {
  # グループ内のデータ更新を購読
  # reportDataByNode mutation がトリガー
  # Note: nullableにすることで、NodeStatusが存在しない場合でもエラーを防ぐ
  onDataUpdateInGroup(groupId: ID!, domain: String!): NodeStatus
    @aws_subscribe(mutations: ["reportDataByNode"])

  # グループ内のバッチイベントを購読
  # fireEventsByNode mutation がトリガー
  onBatchEventInGroup(groupId: ID!, domain: String!): BatchEvent
    @aws_subscribe(mutations: ["fireEventsByNode"])

  # グループ解散通知を購読
  # dissolveGroup mutation がトリガー
  # Note: nullableにすることで、GroupDissolvePayloadが存在しない場合でもエラーを防ぐ
  onGroupDissolve(groupId: ID!, domain: String!): GroupDissolvePayload
    @aws_subscribe(mutations: ["dissolveGroup"])
}

schema {
  query: Query
  mutation: Mutation
  subscription: Subscription
}
